<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TTN Academy Tournament - Team Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    rel="stylesheet"
  />

  <style>
    body {
      background: linear-gradient(135deg, #020617, #0f172a);
      min-height: 100vh;
      color: #f8fafc;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    .page-wrapper {
      padding: 20px 0;
    }

    .glass-card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 18px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.3);
      backdrop-filter: blur(14px);
    }

    .badge-live {
      font-size: 0.7rem;
      letter-spacing: 1px;
    }

    .nav-pills .nav-link {
      border-radius: 999px;
    }

    .nav-pills .nav-link.active {
      background: linear-gradient(135deg, #22c55e, #16a34a);
    }

    .form-label {
      font-weight: 600;
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .form-control,
    .form-select {
      background-color: #020617;
      border-color: #1f2937;
      color: #e5e7eb;
      border-radius: 12px;
    }

    .form-control:focus,
    .form-select:focus {
      box-shadow: 0 0 0 0.2rem rgba(34, 197, 94, 0.35);
      border-color: #22c55e;
      background-color: #020617;
      color: #f9fafb;
    }

    .btn-gradient {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border: none;
      border-radius: 999px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .btn-gradient:disabled {
      opacity: 0.7;
    }

    .btn-outline-soft {
      border-radius: 999px;
    }

    .stat-pill {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.8);
      padding: 8px 14px;
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .table-dark-custom {
      --bs-table-bg: #020617;
      --bs-table-striped-bg: #02091a;
      --bs-table-hover-bg: #050816;
      color: #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
    }

    .input-helper {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    @media (max-width: 767.98px) {
      .glass-card {
        border-radius: 0;
      }
    }

    /* Small style for QR scanner container */
    #qr-reader {
      width: 100%;
      max-width: 360px;
    }
  </style>
</head>
<body>
  <div class="container page-wrapper">
    <!-- HEADER -->
    <div class="text-center mb-4">
      <span class="badge rounded-pill bg-danger badge-live">
        <i class="bi bi-lightning-charge-fill"></i> TTN Academy TOURNAMENT 2026
      </span>
      <h1 class="mt-3 mb-1 fw-bold">
        TTN Academy Tournament Team Register
      </h1>
      <p class="text-secondary mb-1">
        Register your team • Limited slots • No duplicate team names or number
      </p>
      <p class="text-warning small mb-0">
        Registration closes in:
        <span id="timerText" class="fw-bold">
          -- Days  -- Hours  -- Minutes  -- Seconds
        </span>
      </p>
    </div>

    <div class="row justify-content-center">
      <div class="col-12 col-lg-10">
        <div class="glass-card p-3 p-md-4 p-lg-5">
          <!-- Top Row: stats + pills -->
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
            <div class="mb-2 mb-md-0">
              <div class="d-flex flex-wrap gap-2">
                <span class="stat-pill">
                  <i class="bi bi-people-fill me-1"></i>
                  <span id="registeredCountText">0</span> Teams Registered
                </span>
                <span class="stat-pill">
                  <i class="bi bi-flag-fill me-1"></i>
                  Max Teams:
                  <span id="maxTeamsText">--</span>
                </span>
              </div>
            </div>
            <ul class="nav nav-pills" id="mainTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link active"
                  id="register-tab"
                  data-bs-toggle="pill"
                  data-bs-target="#registerTabPane"
                  type="button"
                  role="tab"
                >
                  <i class="bi bi-clipboard-plus me-1"></i> Team Register
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="admin-tab"
                  data-bs-toggle="pill"
                  data-bs-target="#adminTabPane"
                  type="button"
                  role="tab"
                >
                  <i class="bi bi-shield-lock me-1"></i> Admin
                </button>
              </li>
            </ul>
          </div>

          <!-- ALERT AREA -->
          <div id="alertPlaceholder"></div>

          <div class="tab-content mt-3">
            <!-- USER REGISTER TAB -->
            <div
              class="tab-pane fade show active"
              id="registerTabPane"
              role="tabpanel"
            >
              <div class="row g-3">
                <div class="col-12 col-lg-7">
                  <div class="border rounded-4 p-3 p-md-4 h-100">
                    <h5 class="fw-semibold mb-3">
                      <i class="bi bi-pen me-2 text-success"></i>
                      Team Registration Form
                    </h5>

                    <form id="teamRegisterForm" novalidate>
                      <div class="mb-3">
                        <label class="form-label">Team Name *</label>
                        <input
                          type="text"
                          class="form-control"
                          id="teamName"
                          required
                          maxlength="50"
                          placeholder="Ex: Rising Warriors"
                        />
                      </div>

                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <label class="form-label">Captain Name *</label>
                          <input
                            type="text"
                            class="form-control"
                            id="captainName"
                            required
                            maxlength="50"
                            placeholder="Ex: Ajay Kumar"
                          />
                        </div>
                        <div class="col-md-6 mb-3">
                          <label class="form-label">Captain Mobile *</label>
                          <input
                            type="tel"
                            class="form-control"
                            id="captainPhone"
                            required
                            pattern="[0-9]{10}"
                            maxlength="10"
                            placeholder="10 digit number"
                          />
                          <small class="input-helper">
                            10 digit India mobile number.
                          </small>
                        </div>
                      </div>

                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <label class="form-label">District / Area *</label>
                          <input
                            type="text"
                            class="form-control"
                            id="district"
                            required
                            maxlength="60"
                            placeholder="Ex: Madurai"
                          />
                        </div>
                        <div class="col-md-6 mb-3">
                          <label class="form-label">No. of Players *</label>
                          <input
                            type="number"
                            class="form-control"
                            id="playersCount"
                            required
                            min="7"
                            max="15"
                            value="12"
                          />
                        </div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Any Note (optional)</label>
                        <textarea
                          id="note"
                          class="form-control"
                          rows="2"
                          maxlength="200"
                          placeholder="Ex: Need morning slot, jersey color, etc."
                        ></textarea>
                      </div>

                      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mt-2">
                        <div>
                          <small class="text-warning d-block">
                            <i class="bi bi-info-circle me-1"></i>
                            Duplicate team name or captain mobile not allowed.
                          </small>
                        </div>
                        <div class="d-flex gap-2">
                          <button
                            type="reset"
                            class="btn btn-outline-light btn-outline-soft px-3"
                          >
                            <i class="bi bi-arrow-counterclockwise me-1"></i>
                            Clear
                          </button>
                          <button
                            type="submit"
                            class="btn btn-gradient px-4"
                            id="registerBtn"
                          >
                            <i class="bi bi-send-fill me-1"></i>
                            Submit Registration
                          </button>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>

                <!-- Right side info -->
                <div class="col-12 col-lg-5">
                  <div class="border rounded-4 p-3 p-md-4 mb-3">
                    <h6 class="fw-semibold mb-3">
                      <i class="bi bi-info-circle-fill me-2 text-info"></i>
                      Tournament Rules (Short)
                    </h6>
                    <ul class="small text-secondary mb-2">
                      <li>Unique team name & unique captain number only.</li>
                      <li>Limited slots – once full, online register closes.</li>
                      <li>After admin approval, schedule will be shared.</li>
                      <li>Original ID card compulsory for all players.</li>
                    </ul>
                  </div>

                  <div class="border rounded-4 p-3 p-md-4">
                    <h6 class="fw-semibold mb-2">
                      <i class="bi bi-envelope-paper-heart me-2 text-success"></i>
                      Admin Contact
                    </h6>
                    <p class="small mb-1 text-secondary">
                      After registration, admin can download team details & PDF.
                    </p>
                    <p class="small mb-0">
                      <i class="bi bi-envelope me-1"></i>
                      <span id="adminEmailText">admin@ttnacademy.com</span>
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- ADMIN TAB -->
            <div
              class="tab-pane fade"
              id="adminTabPane"
              role="tabpanel"
            >
              <!-- LOGIN CARD -->
              <div id="adminLoginCard" class="row justify-content-center">
                <div class="col-12 col-md-8 col-lg-6">
                  <div class="border rounded-4 p-3 p-md-4">
                    <h5 class="fw-semibold mb-3">
                      <i class="bi bi-shield-lock-fill me-2 text-warning"></i>
                      Admin Login
                    </h5>
                    <form id="adminLoginForm">
                      <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input
                          type="text"
                          class="form-control"
                          id="adminUsername"
                          required
                          placeholder="ttnacademy"
                        />
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input
                          type="password"
                          class="form-control"
                          id="adminPassword"
                          required
                          placeholder="••••••••"
                        />
                      </div>
                      <button type="submit" class="btn btn-gradient w-100">
                        <i class="bi bi-door-open-fill me-1"></i>
                        Login as Admin
                      </button>
                    </form>
                  </div>
                </div>
              </div>

              <!-- ADMIN PANEL -->
              <div id="adminPanel" class="mt-3 d-none">
                <div class="d-flex flex-column flex-md-row justify-content-between mb-3 gap-2">
                  <div>
                    <h5 class="fw-semibold mb-1">
                      <i class="bi bi-speedometer2 me-2 text-success"></i>
                      Admin Control Panel
                    </h5>
                    <p class="small text-secondary mb-0">
                      Only you (admin) can change settings, scan QR & download backups.
                    </p>
                  </div>
                  <button
                    class="btn btn-outline-light btn-outline-soft btn-sm align-self-md-center"
                    id="adminLogoutBtn"
                  >
                    <i class="bi bi-box-arrow-right me-1"></i>
                    Logout
                  </button>
                </div>

                <div class="row g-3">
                  <div class="col-12 col-lg-4">
                    <div class="border rounded-4 p-3 p-md-4 h-100">
                      <h6 class="fw-semibold mb-3">
                        <i class="bi bi-gear-fill me-2 text-info"></i>
                        Tournament Settings
                      </h6>

                      <div class="mb-3">
                        <label class="form-label">Max Teams Allowed</label>
                        <input
                          type="number"
                          class="form-control"
                          id="maxTeamsInput"
                          min="1"
                          max="128"
                        />
                        <small class="input-helper">
                          Example: 8, 12, 16, 32 ...
                        </small>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Admin Email</label>
                        <input
                          type="email"
                          class="form-control"
                          id="adminEmailInput"
                          placeholder="admin@ttnacademy.com"
                        />
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Registration Close Date</label>
                        <input
                          type="date"
                          class="form-control"
                          id="regCloseDateInput"
                        />
                        <small class="input-helper">
                          Empty irundha timer default state la irukkum.
                        </small>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Registration Close Time</label>
                        <input
                          type="time"
                          class="form-control"
                          id="regCloseTimeInput"
                        />
                        <small class="input-helper">
                          24-hr format, example: 18:30.
                        </small>
                      </div>

                      <button
                        class="btn btn-gradient w-100 mb-2"
                        id="saveSettingsBtn"
                      >
                        <i class="bi bi-check2-circle me-1"></i>
                        Save Settings
                      </button>

                      <button
                        class="btn btn-outline-danger w-100 btn-sm mb-2"
                        id="adminResetBtn"
                      >
                        <i class="bi bi-exclamation-triangle-fill me-1"></i>
                        RESET All Data (Admin)
                      </button>

                      <button
                        class="btn btn-outline-light w-100 btn-sm mb-2"
                        id="backupBtn"
                      >
                        <i class="bi bi-download me-1"></i>
                        Download Backup (JSON)
                      </button>

                      <button
                        class="btn btn-outline-light w-100 btn-sm"
                        id="restoreBtn"
                      >
                        <i class="bi bi-upload me-1"></i>
                        Restore Backup (JSON)
                      </button>
                      <input
                        type="file"
                        id="restoreFileInput"
                        accept="application/json"
                        class="d-none"
                      />
                    </div>
                  </div>

                  <div class="col-12 col-lg-8">
                    <div class="border rounded-4 p-3 p-md-4">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-semibold mb-0">
                          <i class="bi bi-list-check me-2 text-warning"></i>
                          Registered Teams
                        </h6>
                        <span class="badge bg-secondary">
                          Total: <span id="adminTotalTeams">0</span>
                        </span>
                      </div>

                      <div class="table-responsive">
                        <table
                          class="table table-dark table-striped table-hover table-dark-custom align-middle mb-0"
                        >
                          <thead>
                            <tr>
                              <th>#</th>
                              <th>Team ID</th>
                              <th>Team</th>
                              <th>Captain</th>
                              <th>Phone</th>
                              <th>District</th>
                              <th>Status</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody id="teamsTableBody"></tbody>
                        </table>
                      </div>

                      <small class="text-secondary d-block mt-2">
                        Data localStorage la store aagum (browser based demo).
                        Real project la database + backend + SMS / Email API use pannunga.
                      </small>
                    </div>
                  </div>
                </div>

                <!-- QR SCAN SECTION -->
                <div class="row g-3 mt-3">
                  <div class="col-12">
                    <div class="border rounded-4 p-3 p-md-4">
                      <h6 class="fw-semibold mb-2">
                        <i class="bi bi-qr-code-scan me-2 text-success"></i>
                        Entry QR Scan Verification
                      </h6>
                      <p class="small text-secondary mb-2">
                        Gate la use pannunga. QR code scan panna:
                        <br />
                        ✔ Valid & first time -> <b>Approved</b> (status change)<br />
                        ⚠ Already approved -> <b>Already scanned</b><br />
                        ❌ Team match aagalena -> <b>Invalid / Rejected</b>
                      </p>
                      <div id="qr-reader" class="border rounded-3 p-2 bg-black bg-opacity-50"></div>
                      <div id="qrScanStatus" class="small mt-2 text-info"></div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- /ADMIN PANEL -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: TEAM DETAIL + QR + PDF -->
  <div class="modal fade" id="teamDetailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title">Team Details</h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body" id="teamDetailContent">
          <!-- Filled by JS -->
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-light btn-sm" id="downloadPdfBtn">
            <i class="bi bi-file-earmark-pdf me-1"></i> Download PDF
          </button>
          <button
            class="btn btn-gradient btn-sm"
            data-bs-dismiss="modal"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS LIBRARIES -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- QRCodeJS (for generating QR) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <!-- html2pdf for PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <!-- html5-qrcode (for scanning) – cdnjs (more stable) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

<script>
  // ==========================
  // CONFIG
  // ==========================
  const DEMO_ADMIN_USERNAME = "ttnacademy";
  const DEMO_ADMIN_PASSWORD = "ttn2025";

  const DEFAULT_SETTINGS = {
    maxTeams: 8,
    adminEmail: "admin@ttnacademy.com",
    registrationCloseDate: "", // yyyy-mm-dd
    registrationCloseTime: "", // HH:MM
  };

  const LS_TEAMS_KEY = "kabaddi_teams";
  const LS_SETTINGS_KEY = "kabaddi_settings";
  const LS_TEAM_COUNTER_KEY = "kabaddi_team_counter";

  // EmailJS Config
  const EMAILJS_PUBLIC_KEY = "pLIgyu0VA0vwUVaql";
  const EMAILJS_SERVICE_ID = "service_oh7fohw";
  const EMAILJS_TEMPLATE_ID = "template_tcbljil";

  // Init EmailJS
  if (typeof emailjs !== "undefined" && EMAILJS_PUBLIC_KEY) {
    emailjs.init(EMAILJS_PUBLIC_KEY);
  }

  // ==========================
  // STORAGE HELPERS
  // ==========================
  function getSettings() {
    try {
      const stored = localStorage.getItem(LS_SETTINGS_KEY);
      const base = stored ? JSON.parse(stored) : {};
      return { ...DEFAULT_SETTINGS, ...base };
    } catch (e) {
      return { ...DEFAULT_SETTINGS };
    }
  }

  function saveSettings(settings) {
    localStorage.setItem(LS_SETTINGS_KEY, JSON.stringify(settings));
  }

  function getTeams() {
    try {
      const stored = localStorage.getItem(LS_TEAMS_KEY);
      return stored ? JSON.parse(stored) : [];
    } catch (e) {
      return [];
    }
  }

  function saveTeams(teams) {
    localStorage.setItem(LS_TEAMS_KEY, JSON.stringify(teams));
  }

  function getNextTeamId() {
    let counter = parseInt(localStorage.getItem(LS_TEAM_COUNTER_KEY) || "0", 10);
    counter += 1;
    localStorage.setItem(LS_TEAM_COUNTER_KEY, String(counter));
    return "TTN" + String(counter).padStart(3, "0"); // TTN001...
  }

  // ==========================
  // REGISTRATION END TIME (ADMIN CONTROLLED)
  // ==========================
  function getRegistrationEndTime() {
    const settings = getSettings();
    const d = settings.registrationCloseDate;
    const t = settings.registrationCloseTime;

    if (!d || !t) {
      return null;
    }

    const isoString = d + "T" + t + ":00";
    const end = new Date(isoString);
    if (isNaN(end.getTime())) {
      return null;
    }
    return end;
  }

  // ==========================
  // ALERT
  // ==========================
  function showAlert(message, type = "success") {
    const box = document.getElementById("alertPlaceholder");
    box.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
  }

  // ==========================
  // SUMMARY UPDATE
  // ==========================
  function refreshSummary() {
    const settings = getSettings();
    const teams = getTeams();

    document.getElementById("registeredCountText").textContent = teams.length;
    document.getElementById("maxTeamsText").textContent = settings.maxTeams;
    document.getElementById("adminEmailText").textContent = settings.adminEmail;

    const registerBtn = document.getElementById("registerBtn");
    const slotsFull = teams.length >= settings.maxTeams;

    const now = new Date();
    const end = getRegistrationEndTime();
    const timeOver = end ? now >= end : false;

    if (slotsFull || timeOver) {
      registerBtn.disabled = true;
      registerBtn.textContent = slotsFull
        ? "Registration Closed (Slots Full)"
        : "Registration Closed (Time Over)";
    } else {
      registerBtn.disabled = false;
      registerBtn.textContent = "Submit Registration";
    }

    const total = document.getElementById("adminTotalTeams");
    if (total) total.textContent = teams.length;
  }

  // ==========================
  // TIMER (ADMIN CONTROLLED END TIME)
  // ==========================
  function updateTimer() {
    const el = document.getElementById("timerText");
    const end = getRegistrationEndTime();

    if (!end) {
      el.textContent = "-- Days  -- Hours  -- Minutes  -- Seconds";
      return;
    }

    const now = new Date();
    const diff = end - now;

    if (diff <= 0) {
      el.textContent = "00 Days  00 Hours  00 Minutes  00 Seconds";
      refreshSummary();
      return;
    }

    const totalSeconds = Math.floor(diff / 1000);
    const days = Math.floor(totalSeconds / (24 * 3600));
    const hours = Math.floor((totalSeconds % (24 * 3600)) / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    el.textContent =
      String(days).padStart(2, "0") + " Days  " +
      String(hours).padStart(2, "0") + " Hours  " +
      String(minutes).padStart(2, "0") + " Minutes  " +
      String(seconds).padStart(2, "0") + " Seconds";
  }

  setInterval(updateTimer, 1000);

  // ==========================
  // ADMIN TABLE
  // ==========================
  function renderStatusBadge(status) {
    const s = status || "Pending";
    if (s === "Approved") {
      return '<span class="badge bg-success">Approved</span>';
    }
    return '<span class="badge bg-secondary">Pending</span>';
  }

  function populateTeamsTable() {
    const teams = getTeams();
    const tbody = document.getElementById("teamsTableBody");

    if (!teams.length) {
      tbody.innerHTML =
        '<tr><td colspan="8" class="text-center text-secondary">No teams registered yet.</td></tr>';
      return;
    }

    tbody.innerHTML = teams
      .map(
        (team, index) => `
        <tr>
          <td>${index + 1}</td>
          <td>${team.teamId}</td>
          <td>${team.teamName}</td>
          <td>${team.captainName}</td>
          <td>${team.captainPhone}</td>
          <td>${team.district}</td>
          <td>${renderStatusBadge(team.status)}</td>
          <td>
            <button
              class="btn btn-sm btn-outline-light view-team-btn"
              data-index="${index}"
            >
              View / PDF
            </button>
          </td>
        </tr>
      `
      )
      .join("");
  }

  function loadAdminSettingsForm() {
    const s = getSettings();
    document.getElementById("maxTeamsInput").value = s.maxTeams;
    document.getElementById("adminEmailInput").value = s.adminEmail;
    document.getElementById("regCloseDateInput").value =
      s.registrationCloseDate || "";
    document.getElementById("regCloseTimeInput").value =
      s.registrationCloseTime || "";
  }

  // ==========================
  // TEAM DETAIL MODAL + QR + PDF
  // ==========================
  let currentModalTeamIndex = null;

  function openTeamModal(index) {
    const teams = getTeams();
    const team = teams[index];
    if (!team) return;
    currentModalTeamIndex = index;

    const container = document.getElementById("teamDetailContent");
    container.innerHTML = `
      <div id="detailForPdf">
        <h5>${team.teamName} <span class="badge bg-success ms-2">${team.teamId}</span></h5>
        <p class="small mb-1">Registered at: ${new Date(
          team.registeredAt
        ).toLocaleString()}</p>
        <hr/>
        <p class="mb-1"><strong>Captain:</strong> ${team.captainName}</p>
        <p class="mb-1"><strong>Phone:</strong> ${team.captainPhone}</p>
        <p class="mb-1"><strong>District:</strong> ${team.district}</p>
        <p class="mb-1"><strong>Players:</strong> ${team.playersCount}</p>
        <p class="mb-3"><strong>Note:</strong> ${
          team.note || "No note provided"
        }</p>
        <div class="mb-2"><strong>Team QR Code:</strong></div>
        <div id="qrCodeBox" class="bg-light p-2 d-inline-block"></div>
      </div>
    `;

    // Generate QR as JSON (more reliable for scan)
    const qrBox = document.getElementById("qrCodeBox");
    qrBox.innerHTML = "";
    const qrPayload = JSON.stringify({
      type: "TTN_TEAM",
      teamId: team.teamId,
    });
    new QRCode(qrBox, {
      text: qrPayload,
      width: 128,
      height: 128,
    });

    const modal = new bootstrap.Modal(
      document.getElementById("teamDetailModal")
    );
    modal.show();
  }

  // PDF Download (wait a bit so QR renders fully)
  document.getElementById("downloadPdfBtn").addEventListener("click", () => {
    const detail = document.getElementById("detailForPdf");
    if (!detail || currentModalTeamIndex === null) return;

    const teams = getTeams();
    const team = teams[currentModalTeamIndex];

    const opt = {
      margin: 10,
      filename: `${team.teamId}_${team.teamName}_receipt.pdf`,
      image: { type: "jpeg", quality: 0.95 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
    };

    // Small delay to make sure QR canvas rendered
    setTimeout(() => {
      html2pdf().set(opt).from(detail).save();
    }, 400);
  });

  // ==========================
  // SMS HOOK (placeholder)
  // ==========================
  function sendSmsToCaptain(team) {
    console.log(
      "SMS sent to:",
      team.captainPhone,
      "TeamID:",
      team.teamId,
      "(hook only - integrate real SMS API)"
    );
  }

  // ==========================
  // EMAIL TO ADMIN (EmailJS)
  // ==========================
  function sendEmailToAdmin(team) {
    const settings = getSettings();

    if (
      !EMAILJS_PUBLIC_KEY ||
      !EMAILJS_SERVICE_ID ||
      !EMAILJS_TEMPLATE_ID ||
      typeof emailjs === "undefined"
    ) {
      console.log("EmailJS not configured properly, skipping email send.");
      return;
    }

    const params = {
      admin_email: settings.adminEmail,
      time: new Date().toLocaleString(),
      team_name: team.teamName,
      team_id: team.teamId,
      captain_name: team.captainName,
      captain_phone: team.captainPhone,
      district: team.district,
      players_count: team.playersCount,
      note: team.note || "No note",
    };

    emailjs
      .send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params)
      .then(() => {
        console.log("Email sent to admin successfully.");
      })
      .catch((err) => {
        console.error("Failed to send email:", err);
      });
  }

  // ==========================
  // BACKUP / RESTORE
  // ==========================
  function downloadBackup() {
    const data = {
      settings: getSettings(),
      teams: getTeams(),
      teamCounter: localStorage.getItem(LS_TEAM_COUNTER_KEY) || "0",
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {
      type: "application/json",
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ttn_tournament_backup.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  function restoreBackup(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        if (data.settings && data.teams) {
          saveSettings(data.settings);
          const patchedTeams = (data.teams || []).map((t) => ({
            ...t,
            status: t.status || "Pending",
          }));
          saveTeams(patchedTeams);
          if (data.teamCounter) {
            localStorage.setItem(LS_TEAM_COUNTER_KEY, data.teamCounter);
          }
          refreshSummary();
          populateTeamsTable();
          updateTimer();
          showAlert("Backup restored successfully!", "success");
        } else {
          showAlert("Invalid backup file.", "danger");
        }
      } catch (err) {
        showAlert("Failed to read backup file.", "danger");
      }
    };
    reader.readAsText(file);
  }

  // ==========================
  // QR SCAN HELPERS
  // ==========================
  function extractTeamIdFromQr(qrText) {
    if (!qrText) return null;

    // 1) Try JSON format first
    try {
      const obj = JSON.parse(qrText);
      if (obj && typeof obj === "object") {
        if (obj.teamId) return String(obj.teamId).toUpperCase();
        if (obj.TeamID) return String(obj.TeamID).toUpperCase();
      }
    } catch (e) {
      // not JSON, continue
    }

    // 2) Try "TeamID: TTN001" style
    const match = qrText.match(/TeamID\s*:\s*([A-Za-z0-9\-]+)/i);
    if (match && match[1]) {
      return match[1].trim().toUpperCase();
    }

    // 3) Fallback: any TTNxxx pattern
    const idMatch = qrText.match(/TTN\d{1,}/i);
    if (idMatch) {
      return idMatch[0].toUpperCase();
    }

    return null;
  }

  function handleQrScan(qrText) {
    const statusEl = document.getElementById("qrScanStatus");
    console.log("Scanned QR text:", qrText);
    const teamId = extractTeamIdFromQr(qrText || "");

    if (!teamId) {
      statusEl.className = "small mt-2 text-danger";
      statusEl.textContent = "❌ Invalid QR: Team ID not found.";
      return;
    }

    const teams = getTeams();
    const index = teams.findIndex((t) => String(t.teamId).toUpperCase() === teamId);

    if (index === -1) {
      statusEl.className = "small mt-2 text-danger";
      statusEl.textContent = `❌ Invalid QR: No team found for ID ${teamId}.`;
      return;
    }

    const team = teams[index];

    if (team.status === "Approved") {
      statusEl.className = "small mt-2 text-warning";
      statusEl.textContent = `⚠ Already scanned: ${team.teamName} (${team.teamId}) is already APPROVED.`;
      return;
    }

    // Approve this team now
    team.status = "Approved";
    team.scannedAt = new Date().toISOString();
    teams[index] = team;
    saveTeams(teams);
    populateTeamsTable();

    statusEl.className = "small mt-2 text-success";
    statusEl.textContent = `✅ Approved: ${team.teamName} (${team.teamId}) entry allowed.`;
  }

  let qrScannerInstance = null;

  function startQrScannerIfNeeded() {
    if (qrScannerInstance || typeof Html5QrcodeScanner === "undefined") {
      return;
    }

    qrScannerInstance = new Html5QrcodeScanner("qr-reader", {
      fps: 10,
      qrbox: 250,
    });

    qrScannerInstance.render(
      (decodedText, decodedResult) => {
        handleQrScan(decodedText);
      },
      (errorMessage) => {
        // ignore frequent decode errors
      }
    );
  }

  // ==========================
  // MAIN EVENTS
  // ==========================
  document.addEventListener("DOMContentLoaded", () => {
    // Ensure existing teams have status field
    const initialTeams = getTeams().map((t) => ({
      ...t,
      status: t.status || "Pending",
    }));
    saveTeams(initialTeams);

    refreshSummary();
    populateTeamsTable();
    updateTimer();

    // REGISTER TEAM
    const teamRegisterForm = document.getElementById("teamRegisterForm");
    teamRegisterForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const settings = getSettings();
      const teams = getTeams();

      // Slot check
      if (teams.length >= settings.maxTeams) {
        return showAlert(
          "Registration closed. All team slots are already filled.",
          "warning"
        );
      }

      // Time check (admin-controlled)
      const end = getRegistrationEndTime();
      if (end && new Date() >= end) {
        return showAlert("Registration time is over.", "warning");
      }

      const form = {
        teamName: document.getElementById("teamName").value.trim(),
        captainName: document.getElementById("captainName").value.trim(),
        captainPhone: document.getElementById("captainPhone").value.trim(),
        district: document.getElementById("district").value.trim(),
        playersCount: document.getElementById("playersCount").value.trim(),
        note: document.getElementById("note").value.trim(),
      };

      // Basic validation
      if (
        !form.teamName ||
        !form.captainName ||
        !form.captainPhone ||
        !form.district ||
        !form.playersCount
      ) {
        return showAlert("Please fill all mandatory (*) fields.", "danger");
      }

      if (!/^[0-9]{10}$/.test(form.captainPhone)) {
        return showAlert("Captain mobile must be 10 digits.", "danger");
      }

      // Duplicate checks
      const teamsNow = getTeams(); // re-read
      const duplicateName = teamsNow.some(
        (t) => t.teamName.toLowerCase() === form.teamName.toLowerCase()
      );
      if (duplicateName) {
        return showAlert(
          "This team name is already registered. Duplicate not allowed.",
          "danger"
        );
      }

      const duplicatePhone = teamsNow.some(
        (t) => t.captainPhone === form.captainPhone
      );
      if (duplicatePhone) {
        return showAlert(
          "This captain mobile number is already used for another team.",
          "danger"
        );
      }

      const newTeam = {
        teamId: getNextTeamId(),
        ...form,
        registeredAt: new Date().toISOString(),
        status: "Pending",
      };

      teamsNow.push(newTeam);
      saveTeams(teamsNow);

      // SMS hook
      sendSmsToCaptain(newTeam);
      // Email to admin
      sendEmailToAdmin(newTeam);

      showAlert(
        `Team registered successfully! Your Team ID is ${newTeam.teamId}`,
        "success"
      );
      teamRegisterForm.reset();
      refreshSummary();
      populateTeamsTable();

      // Open modal for receipt + QR + PDF
      openTeamModal(teamsNow.length - 1);
    });

    // ADMIN LOGIN
    document
      .getElementById("adminLoginForm")
      .addEventListener("submit", (e) => {
        e.preventDefault();
        const user = document.getElementById("adminUsername").value.trim();
        const pass = document.getElementById("adminPassword").value.trim();

        if (
          user === DEMO_ADMIN_USERNAME &&
          pass === DEMO_ADMIN_PASSWORD
        ) {
          document.getElementById("adminLoginCard").classList.add("d-none");
          document.getElementById("adminPanel").classList.remove("d-none");
          loadAdminSettingsForm();
          populateTeamsTable();
          showAlert("Admin login successful.", "success");

          // Start QR scanner after login
          startQrScannerIfNeeded();
        } else {
          showAlert("Invalid admin credentials.", "danger");
        }
      });

    // ADMIN LOGOUT
    document
      .getElementById("adminLogoutBtn")
      .addEventListener("click", () => {
        document.getElementById("adminPanel").classList.add("d-none");
        document.getElementById("adminLoginCard").classList.remove("d-none");
      });

    // SAVE SETTINGS
    document
      .getElementById("saveSettingsBtn")
      .addEventListener("click", () => {
        const maxTeamsValue = parseInt(
          document.getElementById("maxTeamsInput").value,
          10
        );
        const adminEmailValue = document
          .getElementById("adminEmailInput")
          .value.trim();
        const closeDateValue = document
          .getElementById("regCloseDateInput")
          .value;
        const closeTimeValue = document
          .getElementById("regCloseTimeInput")
          .value;

        if (isNaN(maxTeamsValue) || maxTeamsValue <= 0) {
          return showAlert(
            "Please enter a valid max teams (1 or more).",
            "danger"
          );
        }

        if (!adminEmailValue) {
          return showAlert("Please enter admin email.", "danger");
        }

        if (
          (closeDateValue && !closeTimeValue) ||
          (!closeDateValue && closeTimeValue)
        ) {
          return showAlert(
            "Registration close date & time both fill pannunga or both empty va leave pannunga.",
            "danger"
          );
        }

        const settings = {
          maxTeams: maxTeamsValue,
          adminEmail: adminEmailValue,
          registrationCloseDate: closeDateValue || "",
          registrationCloseTime: closeTimeValue || "",
        };
        saveSettings(settings);

        showAlert("Settings saved successfully.", "success");
        refreshSummary();
        updateTimer();
      });

    // ADMIN RESET
    document.getElementById("adminResetBtn").addEventListener("click", () => {
      const confirmText = prompt(
        "⚠ WARNING: This will DELETE ALL team data & settings.\nType ADMIN-RESET to confirm:"
      );
      if (confirmText === "ADMIN-RESET") {
        saveTeams([]);
        saveSettings({ ...DEFAULT_SETTINGS });
        localStorage.setItem(LS_TEAM_COUNTER_KEY, "0");
        refreshSummary();
        populateTeamsTable();
        updateTimer();
        showAlert("All data successfully RESET!", "warning");
      } else {
        showAlert("Reset cancelled.", "info");
      }
    });

    // BACKUP DOWNLOAD
    document.getElementById("backupBtn").addEventListener("click", () => {
      downloadBackup();
    });

    // BACKUP RESTORE
    const restoreInput = document.getElementById("restoreFileInput");
    document.getElementById("restoreBtn").addEventListener("click", () => {
      restoreInput.click();
    });
    restoreInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        restoreBackup(file);
      }
      e.target.value = "";
    });

    // VIEW TEAM (table action)
    document
      .getElementById("teamsTableBody")
      .addEventListener("click", (e) => {
        if (e.target.classList.contains("view-team-btn")) {
          const index = parseInt(e.target.getAttribute("data-index"), 10);
          openTeamModal(index);
        }
      });
  });
</script>
</body>
</html>



