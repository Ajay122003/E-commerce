<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kabaddi Tournament Registration System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
  />

  <!-- jsPDF (for PDF download) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- QRCode (for PDF generation) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- html5-qrcode (for camera scanning) -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      background: radial-gradient(circle at top, #151b2b, #05060a);
      color: #f8f9fa;
      min-height: 100vh;
    }

    .page-wrapper {
      padding: 20px 10px 40px;
    }

    .glass-card {
      background: rgba(15, 23, 42, 0.92);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.7);
    }

    .badge-pill {
      border-radius: 999px;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .section-title {
      font-size: 0.95rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .border-soft {
      border: 1px solid rgba(148, 163, 184, 0.45) !important;
    }

    .form-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #e5e7eb;
    }

    .form-control,
    .form-select {
      background-color: rgba(15, 23, 42, 0.9) !important;
      border-color: rgba(148, 163, 184, 0.7) !important;
      color: #e5e7eb !important;
      font-size: 0.92rem;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: #facc15 !important;
      box-shadow: 0 0 0 0.15rem rgba(250, 204, 21, 0.4) !important;
    }

    .stat-card {
      border-radius: 14px;
      padding: 12px 14px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 64, 175, 0.85));
    }

    .stat-value {
      font-size: 1.2rem;
      font-weight: 700;
    }

    .stat-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #e5e7eb;
    }

    .required-star {
      color: #f97373;
    }

    .error-text {
      font-size: 0.78rem;
      color: #fecaca;
      display: none;
    }

    .nav-pills .nav-link.active {
      background: linear-gradient(135deg, #facc15, #f97316);
      color: #111827 !important;
      font-weight: 600;
    }

    .nav-pills .nav-link {
      color: #e5e7eb;
      border-radius: 999px;
      font-size: 0.86rem;
    }

    .status-open {
      color: #bbf7d0;
    }

    .status-closed {
      color: #fecaca;
    }

    .btn-kabaddi {
      background: linear-gradient(135deg, #f97316, #facc15);
      border: none;
      color: #111827;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 0.85rem;
    }

    .btn-kabaddi:hover {
      filter: brightness(1.05);
      color: #020617;
    }

    .btn-outline-light {
      border-radius: 999px;
      font-size: 0.8rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .table-dark-custom {
      --bs-table-bg: #020617;
      --bs-table-striped-bg: #0f172a;
      --bs-table-border-color: rgba(148, 163, 184, 0.5);
      font-size: 0.84rem;
    }

    .badge-status {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    .countdown {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
        Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem;
    }

    .small-hint {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    @media (max-width: 576px) {
      .stat-card {
        margin-bottom: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="page-wrapper container">
    <!-- Header -->
    <div class="text-center mb-3">
      <span class="badge bg-warning-subtle text-warning-emphasis badge-pill px-3 py-2">
        TTN Acadamy Tournament Registration
      </span>
      
    </div>

    <!-- Navigation: User / Admin / Scan -->
    <ul class="nav nav-pills justify-content-center mb-3" id="viewTabs">
      <li class="nav-item">
        <button class="nav-link active" id="userViewBtn">
          <i class="fa-solid fa-users"></i> Team Registration
        </button>
      </li>

      <li class="nav-item ms-2">
        <button class="nav-link" id="adminViewBtn">
          <i class="fa-solid fa-user-shield"></i> Admin Panel
        </button>
      </li>

      <li class="nav-item ms-2">
        <button class="nav-link" id="scanViewBtn">
          <i class="fa-solid fa-qrcode"></i> Scan QR
        </button>
      </li>
    </ul>

    <!-- === USER VIEW === -->
    <div id="userView" class="glass-card p-3 p-md-4 mb-4">
      <!-- Stats -->
      <div class="row g-3 mb-3">
        <div class="col-12 col-md-4">
          <div class="stat-card h-100 d-flex flex-column justify-content-between">
            <div class="stat-label">Registration Status</div>
            <div class="stat-value" id="regStatusText">OPEN</div>
            <div class="small-hint" id="statusHint">
              You can register your team now.
            </div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="stat-card h-100">
            <div class="stat-label mb-1">Time Left (Registration Close)</div>
            <div id="countdown" class="countdown">-- : -- : -- : --</div>
            <div class="small-hint">Days : Hrs : Min : Sec</div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="stat-card h-100">
            <div class="stat-label mb-1">Total Teams Registered</div>
            <div class="stat-value" id="totalTeams">0</div>
            <div class="small-hint">(Based on stored data in this browser)</div>
          </div>
        </div>
      </div>

      <!-- Registration Form -->
      <h6 class="section-title mb-2">Team Registration Form</h6>
      <p class="small-hint mb-3">
        Fill your team details below. All fields marked with
        <span class="required-star">*</span> are required.
      </p>

      <form id="teamForm" class="border-soft rounded-4 p-3 p-md-4">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="teamName" class="form-label">
              Team Name <span class="required-star">*</span>
            </label>
            <input type="text" id="teamName" class="form-control" placeholder="Ex: Warriors Kabaddi Club" />
            <div class="error-text" data-error="teamName">
              Please enter team name.
            </div>
          </div>

          <div class="col-md-6">
            <label for="captainName" class="form-label">
              Captain Name <span class="required-star">*</span>
            </label>
            <input type="text" id="captainName" class="form-control" placeholder="Ex: Ajay" />
            <div class="error-text" data-error="captainName">
              Please enter captain name.
            </div>
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-md-4">
            <label for="phone" class="form-label">
              Phone Number <span class="required-star">*</span>
            </label>
            <input type="tel" id="phone" class="form-control" maxlength="10" placeholder="10-digit mobile" />
            <div class="error-text" data-error="phone">
              Enter valid 10-digit phone number.
            </div>
          </div>
          <div class="col-md-4">
            <label for="village" class="form-label">
              Village <span class="required-star">*</span>
            </label>
            <input type="text" id="village" class="form-control" placeholder="Ex: Kovilpalayam" />
            <div class="error-text" data-error="village">
              Please enter village.
            </div>
          </div>
          <div class="col-md-4">
            <label for="district" class="form-label">
              District <span class="required-star">*</span>
            </label>
            <input type="text" id="district" class="form-control" placeholder="Ex: Coimbatore" />
            <div class="error-text" data-error="district">
              Please enter district.
            </div>
          </div>
        </div>

        <!-- Declaration -->
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" id="agreeCheck" />
          <label class="form-check-label small" for="agreeCheck">
            We confirm that all details are true and we agree to follow the tournament rules & decisions.
          </label>
          <div class="error-text" data-error="agree">
            Please accept the declaration to continue.
          </div>
        </div>

        <!-- Buttons -->
        <div class="d-flex flex-wrap justify-content-between align-items-center mt-3">
          <button type="button" id="resetFormBtn" class="btn btn-outline-light btn-sm">
            <i class="fa-solid fa-rotate-left"></i> Reset
          </button>
          <button type="submit" id="submitBtn" class="btn btn-kabaddi btn-sm">
            <i class="fa-solid fa-paper-plane"></i> Submit Registration
          </button>
        </div>
      </form>

      <!-- Success Card -->
      <div id="successCard" class="alert alert-success mt-3 mb-0 py-3 d-none">
        <div class="d-flex justify-content-between align-items-start flex-wrap">
          <div class="me-3">
            <h6 class="mb-1 text-success-emphasis text-uppercase small">
              Registration Successful
            </h6>
            <p class="mb-1 small">
              Your team is registered for the Kabaddi tournament.
            </p>
            <p class="mb-1 small">
              <strong>Registration ID:</strong> <span id="successRegId"></span>
            </p>
            <p class="mb-1 small d-none" id="paymentInfo"></p>
          </div>
          <div class="text-end">
            <button class="btn btn-outline-success btn-sm mb-1" id="downloadPdfBtn">
              <i class="fa-solid fa-file-pdf"></i> Download PDF
            </button>
            <br />
            <button class="btn btn-outline-primary btn-sm" id="emailBtn">
              <i class="fa-solid fa-envelope"></i> Open Email
            </button>
            <p class="small-hint mb-0 mt-1">
              Auto-email send panna backend thevai (SMTP / API).
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- === ADMIN VIEW === -->
    <div id="adminView" class="glass-card p-3 p-md-4 d-none">
      <h6 class="section-title mb-2">
        Admin Login & Dashboard
      </h6>

      <!-- Admin Login Box -->
      <div id="adminLoginBox" class="border-soft rounded-4 p-3 p-md-4 mb-3">
        <p class="small-hint mb-2">
          Demo credentials: <strong>Username:</strong> admin,
          <strong>Password:</strong> kabaddi123
        </p>
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label" for="adminUsername">Username</label>
            <input type="text" id="adminUsername" class="form-control" />
          </div>
          <div class="col-md-4">
            <label class="form-label" for="adminPassword">Password</label>
            <input type="password" id="adminPassword" class="form-control" />
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button id="adminLoginBtn" class="btn btn-kabaddi w-100 btn-sm">
              <i class="fa-solid fa-right-to-bracket"></i> Login
            </button>
          </div>
        </div>
        <div id="adminLoginError" class="text-danger small mt-2 d-none">
          Invalid username or password.
        </div>
      </div>

      <!-- Admin Dashboard -->
      <div id="adminDashboard" class="d-none">
        <!-- Top row -->
        <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
          <div>
            <h6 class="mb-0 text-warning">Welcome, Admin</h6>
            <p class="small-hint mb-0">
              Manage registrations, view teams & control registration window.
            </p>
          </div>
          <div class="mt-2 mt-md-0">
            <button id="adminLogoutBtn" class="btn btn-outline-light btn-sm">
              <i class="fa-solid fa-arrow-right-from-bracket"></i> Logout
            </button>
          </div>
        </div>

        <!-- Registration Control -->
        <div class="border-soft rounded-4 p-3 mb-3">
          <h6 class="mb-2 text-uppercase small text-secondary">
            Registration & Payment Settings
          </h6>
          <div class="row g-2 align-items-end">
            <div class="col-md-3">
              <label for="adminRegStatus" class="form-label">Status</label>
              <select id="adminRegStatus" class="form-select form-select-sm">
                <option value="open">Open</option>
                <option value="closed">Closed</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="adminDeadline" class="form-label">Registration Deadline</label>
              <input type="datetime-local" id="adminDeadline" class="form-control form-control-sm" />
              <div class="small-hint">
                Countdown on user page uses this deadline.
              </div>
            </div>
            <div class="col-md-2">
              <label for="paymentRequired" class="form-label">Payment?</label>
              <select id="paymentRequired" class="form-select form-select-sm">
                <option value="no">No</option>
                <option value="yes">Yes</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="entryFee" class="form-label">Entry Fee (₹)</label>
              <input type="number" id="entryFee" class="form-control form-control-sm" placeholder="Ex: 500" />
            </div>
          </div>
          <div class="col-md-3">
             <label for="maxTeams" class="form-label">Max Teams</label>
             <input type="number" id="maxTeams" class="form-control form-control-sm" placeholder="Ex: 32" />
             <div class="small-hint">How many teams can register?</div>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-md-8">
              <label for="paymentNote" class="form-label">Payment Note / Instructions</label>
              <input
                type="text"
                id="paymentNote"
                class="form-control form-control-sm"
                placeholder="Ex: Pay on ground / UPI ID: 98xxxx@upi"
              />
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <button id="saveSettingsBtn" class="btn btn-kabaddi w-100 btn-sm">
                <i class="fa-solid fa-floppy-disk"></i> Save Settings
              </button>
            </div>
          </div>
          <p class="small-hint mt-2 mb-0">
            Payment pannuma pannatha decide pannradhu admin dhan. User form la payment field illa.
          </p>
        </div>

        <!-- Team List -->
        <div class="border-soft rounded-4 p-3">
          <div class="d-flex justify-content-between align-items-center flex-wrap mb-2">
            <div class="mb-2 mb-md-0">
              <h6 class="mb-0 text-uppercase small text-secondary">
                Registered Teams
              </h6>
              <span class="small-hint" id="teamCountText">0 team(s) found.</span>
            </div>
            <div class="d-flex flex-wrap gap-2">
              <input
                type="text"
                id="searchDistrict"
                class="form-control form-control-sm"
                placeholder="Filter by district..."
              />
              <button id="exportCsvBtn" class="btn btn-outline-light btn-sm">
                <i class="fa-solid fa-file-csv"></i> Export CSV
              </button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-dark table-striped table-dark-custom align-middle mb-0">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Reg ID</th>
                  <th>Team</th>
                  <th>Captain</th>
                  <th>Phone</th>
                  <th>Location</th>
                  <th>Status</th>
                  <th>Time</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="adminTeamTable">
                <tr>
                  <td colspan="9" class="text-center small text-secondary">
                    No registrations yet.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <p class="small-hint mt-2 mb-0">
            Data stored in this browser's localStorage. Real multi-device sync ku backend integrate pannalaam.
          </p>
        </div>
      </div>
    </div>

    <!-- === QR SCANNER VIEW === -->
    <div id="scanView" class="glass-card p-3 p-md-4 d-none">
      <h5 class="text-warning mb-2">
        <i class="fa-solid fa-qrcode"></i> QR Code Scanner
      </h5>

      <div id="qr-reader" style="width:100%; max-width:400px;"></div>

      <div id="scanResult" class="mt-3 d-none">
        <h6 class="text-success">Team Found</h6>
        <p><b>Reg ID:</b> <span id="scanRegId"></span></p>
        <p><b>Team Name:</b> <span id="scanTeamName"></span></p>
        <p><b>Captain:</b> <span id="scanCaptain"></span></p>
        <p><b>Phone:</b> <span id="scanPhone"></span></p>
        <p><b>Village:</b> <span id="scanVillage"></span></p>
        <p><b>District:</b> <span id="scanDistrict"></span></p>

        <button class="btn btn-success btn-sm mt-2" id="scanVerifyBtn">Verify</button>
        <button class="btn btn-danger btn-sm mt-2" id="scanRejectBtn">Reject</button>
      </div>

      <p class="small text-secondary mt-3">
        Use back camera for best results. Scan PDF la irukkura QR.
      </p>
    </div>
  </div>

  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ================== SIMPLE CONFIG ==================
    const ADMIN_EMAIL = "organizer@example.com"; // email open button-ku
    const STORAGE_KEY_TEAMS = "kabaddiTeams_simple";
    const STORAGE_KEY_SETTINGS = "kabaddiSettings_simple";
    const DEFAULT_ADMIN_USER = "admin";
    const DEFAULT_ADMIN_PASS = "kabaddi123";

    // ================== LOCAL STORAGE HELPERS ==================
    function loadTeams() {
      try {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY_TEAMS));
        return Array.isArray(data) ? data : [];
      } catch {
        return [];
      }
    }

    function saveTeams(teams) {
      localStorage.setItem(STORAGE_KEY_TEAMS, JSON.stringify(teams));
    }

    function createDefaultSettings() {
      const now = new Date();
      const defaultDeadline = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
      const settings = {
        status: "open",
        deadline: defaultDeadline.toISOString(),
        paymentRequired: "no",
        entryFee: "",
        paymentNote: "",
      };
      localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings));
      return settings;
    }

    function loadSettings() {
      try {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY_SETTINGS));
        if (data && data.status && data.deadline) return data;
      } catch {}
      return createDefaultSettings();
    }

    function saveSettings(settings) {
      localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings));
    }

    // ================== COMMON HELPERS ==================
    function formatDateTime(dtStr) {
      if (!dtStr) return "-";
      const dt = new Date(dtStr);
      if (isNaN(dt)) return "-";
      return (
        dt.toLocaleDateString("en-IN", {
          year: "numeric",
          month: "short",
          day: "numeric",
        }) +
        " " +
        dt.toLocaleTimeString("en-IN", {
          hour: "2-digit",
          minute: "2-digit",
        })
      );
    }

    function generateRegId(index) {
      const year = new Date().getFullYear();
      const num = String(index + 1).padStart(3, "0");
      return `KBD${year}-${num}`;

    }

    function countDownText(deadlineStr) {
      const now = new Date().getTime();
      const target = new Date(deadlineStr).getTime();
      if (isNaN(target) || target <= now) return "00 : 00 : 00 : 00";

      const diff = target - now;
      const d = Math.floor(diff / (1000 * 60 * 60 * 24));
      const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
      const m = Math.floor((diff / (1000 * 60)) % 60);
      const s = Math.floor((diff / 1000) % 60);

      const pad = (n) => String(n).padStart(2, "0");
      return `${pad(d)} : ${pad(h)} : ${pad(m)} : ${pad(s)}`;

    }

    function showError(id, show) {
      const el = document.querySelector(`.error-text[data-error="${id}"]`);
      if (!el) return;
      el.style.display = show ? "block" : "none";
    }

    // ================== ELEMENTS ==================
    const userViewBtn = document.getElementById("userViewBtn");
    const adminViewBtn = document.getElementById("adminViewBtn");
    const scanViewBtn = document.getElementById("scanViewBtn");

    const userView = document.getElementById("userView");
    const adminView = document.getElementById("adminView");
    const scanView = document.getElementById("scanView");

    const regStatusText = document.getElementById("regStatusText");
    const statusHint = document.getElementById("statusHint");
    const countdownEl = document.getElementById("countdown");
    const totalTeamsEl = document.getElementById("totalTeams");

    const teamForm = document.getElementById("teamForm");
    const resetFormBtn = document.getElementById("resetFormBtn");
    const successCard = document.getElementById("successCard");
    const successRegId = document.getElementById("successRegId");
    const paymentInfo = document.getElementById("paymentInfo");
    const downloadPdfBtn = document.getElementById("downloadPdfBtn");
    const emailBtn = document.getElementById("emailBtn");

    const teamNameInput = document.getElementById("teamName");
    const captainNameInput = document.getElementById("captainName");
    const phoneInput = document.getElementById("phone");
    const villageInput = document.getElementById("village");
    const districtInput = document.getElementById("district");
    const agreeCheck = document.getElementById("agreeCheck");

    // admin
    const adminLoginBox = document.getElementById("adminLoginBox");
    const adminDashboard = document.getElementById("adminDashboard");
    const adminUsername = document.getElementById("adminUsername");
    const adminPassword = document.getElementById("adminPassword");
    const adminLoginBtn = document.getElementById("adminLoginBtn");
    const adminLoginError = document.getElementById("adminLoginError");
    const adminLogoutBtn = document.getElementById("adminLogoutBtn");

    const adminRegStatus = document.getElementById("adminRegStatus");
    const adminDeadline = document.getElementById("adminDeadline");
    const paymentRequiredSelect = document.getElementById("paymentRequired");
    const entryFeeInput = document.getElementById("entryFee");
    const paymentNoteInput = document.getElementById("paymentNote");
    const saveSettingsBtn = document.getElementById("saveSettingsBtn");

    const adminTeamTable = document.getElementById("adminTeamTable");
    const teamCountText = document.getElementById("teamCountText");
    const searchDistrict = document.getElementById("searchDistrict");
    const exportCsvBtn = document.getElementById("exportCsvBtn");

    // scan view
    const scanResult = document.getElementById("scanResult");
    const scanRegIdSpan = document.getElementById("scanRegId");
    const scanTeamNameSpan = document.getElementById("scanTeamName");
    const scanCaptainSpan = document.getElementById("scanCaptain");
    const scanPhoneSpan = document.getElementById("scanPhone");
    const scanVillageSpan = document.getElementById("scanVillage");
    const scanDistrictSpan = document.getElementById("scanDistrict");
    const scanVerifyBtn = document.getElementById("scanVerifyBtn");
    const scanRejectBtn = document.getElementById("scanRejectBtn");

    // QR scanner instance
    let html5Qr = null;
    let lastScannedTeam = null;

    // ================== VIEW TOGGLE ==================
    function stopScanner() {
      if (html5Qr) {
        html5Qr.stop().then(() => {
          html5Qr.clear();
          html5Qr = null;
        }).catch(() => {});
      }
    }

    userViewBtn.addEventListener("click", () => {
      stopScanner();
      userViewBtn.classList.add("active");
      adminViewBtn.classList.remove("active");
      scanViewBtn.classList.remove("active");

      userView.classList.remove("d-none");
      adminView.classList.add("d-none");
      scanView.classList.add("d-none");
    });

    adminViewBtn.addEventListener("click", () => {
      stopScanner();
      adminViewBtn.classList.add("active");
      userViewBtn.classList.remove("active");
      scanViewBtn.classList.remove("active");

      adminView.classList.remove("d-none");
      userView.classList.add("d-none");
      scanView.classList.add("d-none");
    });

    scanViewBtn.addEventListener("click", () => {
      scanViewBtn.classList.add("active");
      adminViewBtn.classList.remove("active");
      userViewBtn.classList.remove("active");

      scanView.classList.remove("d-none");
      userView.classList.add("d-none");
      adminView.classList.add("d-none");

      startQRScanner();
    });

    // ================== STATUS & STATS ==================
    function refreshStats() {
      const teams = loadTeams();
      totalTeamsEl.textContent = teams.length;
    }

    function refreshStatusAndCountdown() {
      const settings = loadSettings();
      const now = new Date().getTime();
      const deadline = new Date(settings.deadline).getTime();
      const isOpen = settings.status === "open" && deadline > now;

      if (isOpen) {
        regStatusText.textContent = "OPEN";
        regStatusText.classList.add("status-open");
        regStatusText.classList.remove("status-closed");
        statusHint.textContent = "You can register your team now.";
      } else {
        regStatusText.textContent = "CLOSED";
        regStatusText.classList.remove("status-open");
        regStatusText.classList.add("status-closed");
        statusHint.textContent =
          "Registration closed. Please contact admin for any queries.";
      }

      countdownEl.textContent = countDownText(settings.deadline);
      return { isOpen, settings };
    }

    // ================== USER FORM SUBMIT ==================
    teamForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const { isOpen, settings } = refreshStatusAndCountdown();

      if (!isOpen) {
        alert("Registration is closed. Please contact admin.");
        return;
      }

      let valid = true;

      const requiredFields = [
        { el: teamNameInput, id: "teamName" },
        { el: captainNameInput, id: "captainName" },
        { el: phoneInput, id: "phone" },
        { el: villageInput, id: "village" },
        { el: districtInput, id: "district" },
      ];

      requiredFields.forEach((f) => {
        if (!f.el.value.trim()) {
          showError(f.id, true);
          valid = false;
        } else {
          showError(f.id, false);
        }
      });

      const phoneVal = phoneInput.value.trim();
      if (!/^[0-9]{10}$/.test(phoneVal)) {
        showError("phone", true);
        valid = false;
      }

      if (!agreeCheck.checked) {
        showError("agree", true);
        valid = false;
      } else {
        showError("agree", false);
      }

      if (!valid) return;

      const teams = loadTeams();
      const index = teams.length;
      const regId = generateRegId(index);

      // duplicate check: same phone + same village+district
      const already = teams.find(
        (t) =>
          t.phone === phoneVal &&
          t.village.toLowerCase() === villageInput.value.trim().toLowerCase() &&
          t.district.toLowerCase() === districtInput.value.trim().toLowerCase()
      );
      if (already) {
        alert("This team / phone already registered from same area.");
        return;
      }

      const teamObj = {
        regId,
        teamName: teamNameInput.value.trim(),
        captainName: captainNameInput.value.trim(),
        phone: phoneVal,
        village: villageInput.value.trim(),
        district: districtInput.value.trim(),
        status: "Pending",
        createdAt: new Date().toISOString(),
      };

      teams.push(teamObj);
      saveTeams(teams);

      refreshStats();
      refreshAdminTable();

      successRegId.textContent = regId;

      if (settings.paymentRequired === "yes") {
        const feeText = settings.entryFee ? `Entry Fee: ₹${settings.entryFee}` : "Entry fee applicable";
        const noteText = settings.paymentNote || "";
        paymentInfo.textContent = `${feeText}. ${noteText.trim()}`;
        paymentInfo.classList.remove("d-none");
      } else {
        paymentInfo.textContent = "Admin set: No entry fee or payment not required.";
        paymentInfo.classList.remove("d-none");
      }

      successCard.classList.remove("d-none");
      successCard.scrollIntoView({ behavior: "smooth", block: "center" });
    });

    resetFormBtn.addEventListener("click", () => {
      teamForm.reset();
      successCard.classList.add("d-none");
      document.querySelectorAll(".error-text").forEach((e) => {
        e.style.display = "none";
      });
    });

    // ================== PDF GENERATION ==================
    downloadPdfBtn.addEventListener("click", () => {
      const regId = successRegId.textContent;
      const teams = loadTeams();
      const team = teams.find((t) => t.regId === regId);
      if (!team) {
        alert("Team data not found.");
        return;
      }

      const settings = loadSettings();
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("Kabaddi Tournament Registration", 14, 18);
      doc.setFontSize(11);
      doc.text(`Registration ID: ${team.regId}`, 14, 26);


      doc.setFontSize(10);
      let y = 36;

      const addLine = (label, value) => {
        doc.text(`${label}: ${value || "-"}`, 14, y);
        y += 6;
      };

      addLine("Team Name", team.teamName);
      addLine("Captain Name", team.captainName);
      addLine("Phone", team.phone);
      addLine("Village", team.village);
      addLine("District", team.district);
      addLine("Registered At", formatDateTime(team.createdAt));
      addLine("Status", team.status);

      if (settings.paymentRequired === "yes") {
        addLine("Payment Required", "YES");
        addLine("Entry Fee", settings.entryFee ? `₹${settings.entryFee}` : "-");
        addLine("Payment Note", settings.paymentNote || "-");
      } else {
        addLine("Payment Required", "NO");
      }

      // QR data = just Registration ID (easy for scanner)
      const qrData = team.regId;
      const tempDiv = document.createElement("div");
      const qr = new QRCode(tempDiv, {
        text: qrData,
        width: 120,
        height: 120,
      });

      setTimeout(() => {
        try {
          const img = tempDiv.querySelector("img");
          if (img) {
            const imgData = img.src;
            doc.addImage(imgData, "PNG", 140, 18, 50, 50);
          }
          doc.save(`${team.regId}_registration.pdf`);

        } catch (err) {
          console.error(err);
          doc.save(`${team.regId}_registration.pdf`);

        }
      }, 300);
    });

   // ================== EMAIL (MAILTO) ==================
emailBtn.addEventListener("click", () => {
  const regId = successRegId.textContent;
  const teams = loadTeams();
  const team = teams.find((t) => t.regId === regId);
  if (!team) {
    alert("Team data not found.");
    return;
  }

  const settings = loadSettings();

  const toEmail = ADMIN_EMAIL;
  const subject = encodeURIComponent(
    `Kabaddi Registration - ${team.regId} - ${team.teamName}`
  );

  const bodyLines = [
    "Kabaddi Tournament Registration",
    "",
    `Registration ID: ${team.regId}`,
    `Team Name: ${team.teamName}`,
    `Captain: ${team.captainName}`,
    `Phone: ${team.phone}`,
    `Village: ${team.village}`,
    `District: ${team.district}`,
    `Registered At: ${formatDateTime(team.createdAt)}`,
    `Payment Required: ${settings.paymentRequired === "yes" ? "YES" : "NO"}`,
  ];

  if (settings.paymentRequired === "yes") {
    bodyLines.push(`Entry Fee: ${settings.entryFee ? "₹" + settings.entryFee : "-"}`);
    if (settings.paymentNote) bodyLines.push(`Payment Note: ${settings.paymentNote}`);
  }

  const body = encodeURIComponent(bodyLines.join("\n"));
  const mailtoLink = `mailto:${toEmail}?subject=${subject}&body=${body}`;
  window.location.href = mailtoLink;
});

    // ================== ADMIN LOGIN ==================
    let adminLoggedIn = false;

    adminLoginBtn.addEventListener("click", () => {
      const user = adminUsername.value.trim();
      const pass = adminPassword.value.trim();
      if (user === DEFAULT_ADMIN_USER && pass === DEFAULT_ADMIN_PASS) {
        adminLoggedIn = true;
        adminLoginBox.classList.add("d-none");
        adminDashboard.classList.remove("d-none");
        adminLoginError.classList.add("d-none");
        loadAdminSettingsIntoUI();
        refreshAdminTable();
      } else {
        adminLoginError.classList.remove("d-none");
      }
    });

    adminLogoutBtn.addEventListener("click", () => {
      adminLoggedIn = false;
      adminDashboard.classList.add("d-none");
      adminLoginBox.classList.remove("d-none");
      adminUsername.value = "";
      adminPassword.value = "";
    });

    function loadAdminSettingsIntoUI() {
      const settings = loadSettings();
      adminRegStatus.value = settings.status;
      paymentRequiredSelect.value = settings.paymentRequired || "no";
      entryFeeInput.value = settings.entryFee || "";
      paymentNoteInput.value = settings.paymentNote || "";

      const dt = new Date(settings.deadline);
      if (!isNaN(dt)) {
        const localISO = new Date(
          dt.getTime() - dt.getTimezoneOffset() * 60000
        )
          .toISOString()
          .slice(0, 16);
        adminDeadline.value = localISO;
      }
    }

    saveSettingsBtn.addEventListener("click", () => {
      const status = adminRegStatus.value;
      const deadlineVal = adminDeadline.value;
      if (!deadlineVal) {
        alert("Please select a deadline datetime.");
        return;
      }

      const dt = new Date(deadlineVal);
      const paymentRequired = paymentRequiredSelect.value;
      const entryFee = entryFeeInput.value.trim();
      const paymentNote = paymentNoteInput.value.trim();

      const settings = {
        status,
        deadline: dt.toISOString(),
        paymentRequired,
        entryFee,
        paymentNote,
      };
      saveSettings(settings);
      refreshStatusAndCountdown();
      alert("Settings saved successfully.");
    });

    // ================== ADMIN TABLE ==================
    function refreshAdminTable() {
      const teams = loadTeams();
      const filterDist = searchDistrict.value.trim().toLowerCase();
      let filtered = teams;

      if (filterDist) {
        filtered = teams.filter((t) =>
          (t.district || "").toLowerCase().includes(filterDist)
        );
      }

      teamCountText.textContent = `${filtered.length} team(s) found.`;


      if (filtered.length === 0) {
        adminTeamTable.innerHTML = `
          <tr>
            <td colspan="9" class="text-center small text-secondary">
              No registrations found.
            </td>
          </tr>
        `;
        return;
      }

      adminTeamTable.innerHTML = "";
      filtered.forEach((t, idx) => {
        const tr = document.createElement("tr");

        const statusBadgeClass =
          t.status === "Verified"
            ? "bg-success"
            : t.status === "Rejected"
            ? "bg-danger"
            : "bg-warning text-dark";

        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td class="small">${t.regId}</td>
          <td class="small">${t.teamName}</td>
          <td class="small">${t.captainName}</td>
          <td class="small">${t.phone}</td>
          <td class="small">${t.village}, ${t.district}</td>
          <td>
            <span class="badge badge-status ${statusBadgeClass}">
              ${t.status}
            </span>
          </td>
          <td class="small">${formatDateTime(t.createdAt)}</td>
          <td class="small">
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-success btn-sm" data-action="verify" data-id="${t.regId}">
                ✓
              </button>
              <button class="btn btn-outline-danger btn-sm" data-action="reject" data-id="${t.regId}">
                ✕
              </button>
              <button class="btn btn-outline-info btn-sm" data-action="pdf" data-id="${t.regId}">
                <i class="fa-solid fa-file-pdf"></i>
              </button>
              <button class="btn btn-outline-light btn-sm" data-action="delete" data-id="${t.regId}">
                <i class="fa-solid fa-trash-can"></i>
              </button>
            </div>
          </td>
        `;
        adminTeamTable.appendChild(tr);
      });
    }

    adminTeamTable.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      const action = btn.getAttribute("data-action");
      const regId = btn.getAttribute("data-id");
      if (!action || !regId) return;

      const teams = loadTeams();
      const idx = teams.findIndex((t) => t.regId === regId);
      if (idx === -1) return;

      if (action === "verify") {
        teams[idx].status = "Verified";
        saveTeams(teams);
        refreshAdminTable();
      } else if (action === "reject") {
        teams[idx].status = "Rejected";
        saveTeams(teams);
        refreshAdminTable();
      } else if (action === "delete") {
        if (confirm("Are you sure to delete this team?")) {
          teams.splice(idx, 1);
          saveTeams(teams);
          refreshStats();
          refreshAdminTable();
        }
      } else if (action === "pdf") {
        successRegId.textContent = regId;
        downloadPdfBtn.click();
      }
    });

    searchDistrict.addEventListener("input", () => {
      refreshAdminTable();
    });

    // ================== CSV EXPORT ==================
    exportCsvBtn.addEventListener("click", () => {
      const teams = loadTeams();
      if (!teams.length) {
        alert("No registrations to export.");
        return;
      }

      const headers = [
        "Reg ID",
        "Team Name",
        "Captain Name",
        "Phone",
        "Village",
        "District",
        "Status",
        "Registered At",
      ];

      const rows = teams.map((t) => [
        t.regId,
        t.teamName,
        t.captainName,
        t.phone,
        t.village,
        t.district,
        t.status,
        formatDateTime(t.createdAt),
      ]);

      let csvContent = headers.join(",") + "\n";
      rows.forEach((r) => {
        const row = r
          .map((x) => `"${String(x || "").replace(/"/g, '""')}"`)

          .join(",");
        csvContent += row + "\n";
      });

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "kabaddi_registrations.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // ================== QR SCAN LOGIC ==================
    function startQRScanner() {
      scanResult.classList.add("d-none");
      lastScannedTeam = null;

      if (html5Qr) {
        stopScanner();
      }

      html5Qr = new Html5Qrcode("qr-reader");

      html5Qr
        .start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            const scannedId = decodedText.trim();
            console.log("QR scanned:", scannedId);

            const teams = loadTeams();
            const team = teams.find((t) => t.regId === scannedId);
            if (!team) {
              alert("No team found for this QR.");
              return;
            }

            lastScannedTeam = { team, teams };

            scanRegIdSpan.textContent = team.regId;
            scanTeamNameSpan.textContent = team.teamName;
            scanCaptainSpan.textContent = team.captainName;
            scanPhoneSpan.textContent = team.phone;
            scanVillageSpan.textContent = team.village;
            scanDistrictSpan.textContent = team.district;

            scanResult.classList.remove("d-none");

            // Stop after first successful scan
            stopScanner();
          },
          (error) => {
            // console.warn("Scan error:", error);
          }
        )
        .catch((err) => {
          console.error("Camera start error:", err);
          alert("Unable to access camera. Please allow camera permission.");
        });
    }

    scanVerifyBtn.addEventListener("click", () => {
      if (!lastScannedTeam) return;
      const { team, teams } = lastScannedTeam;
      const idx = teams.findIndex((t) => t.regId === team.regId);
      if (idx === -1) return;
      teams[idx].status = "Verified";
      saveTeams(teams);
      alert("Team Verified!");
      refreshAdminTable();
    });

    scanRejectBtn.addEventListener("click", () => {
      if (!lastScannedTeam) return;
      const { team, teams } = lastScannedTeam;
      const idx = teams.findIndex((t) => t.regId === team.regId);
      if (idx === -1) return;
      teams[idx].status = "Rejected";
      saveTeams(teams);
      alert("Team Rejected!");
      refreshAdminTable();
    });

    // ================== INITIAL LOAD ==================
    refreshStats();
    refreshStatusAndCountdown();
    refreshAdminTable();
    setInterval(() => {
      refreshStatusAndCountdown();
    }, 1000);
  </script>
</body>
</html>